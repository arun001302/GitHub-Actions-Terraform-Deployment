#------------------------------------------------------------------------------
# Terraform CI/CD Pipeline
#------------------------------------------------------------------------------

name: "Terraform CI/CD Pipeline"

on:
  pull_request:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform.yml'

  push:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply

env:
  TF_VERSION: "1.5.7"
  AWS_REGION: "us-east-1"
  TF_ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  #----------------------------------------------------------------------------
  # Job 1: Format Check
  #----------------------------------------------------------------------------
  format:
    name: "Terraform Format"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Fail if Format Check Failed
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "::error::Terraform format check failed. Run 'terraform fmt -recursive' locally and commit the changes."
          exit 1

  #----------------------------------------------------------------------------
  # Job 2: Validate
  #----------------------------------------------------------------------------
  validate:
    name: "Terraform Validate"
    runs-on: ubuntu-latest
    needs: format

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (No Backend)
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate -no-color

  #----------------------------------------------------------------------------
  # Job 3: Security Scan
  #----------------------------------------------------------------------------
  security:
    name: "Security Scan"
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize TFLint
        run: tflint --init
        continue-on-error: true

      - name: Run TFLint
        run: tflint --recursive --format=compact
        continue-on-error: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: cli
          quiet: true
        continue-on-error: true

  #----------------------------------------------------------------------------
  # Job 4: Plan
  #----------------------------------------------------------------------------
  plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    needs: security

    outputs:
      plan_exit_code: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-terraform

      - name: Terraform Init
        run: terraform init

      - name: Select Workspace
        run: |
          terraform workspace select ${{ env.TF_ENVIRONMENT }} || \
          terraform workspace new ${{ env.TF_ENVIRONMENT }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file=environments/${{ env.TF_ENVIRONMENT }}.tfvars \
            -out=tfplan \
            -no-color 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ env.TF_ENVIRONMENT }}
          path: |
            tfplan
            plan_output.txt
          retention-days: 7

      - name: Post Plan Summary
        run: |
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -100 plan_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  #----------------------------------------------------------------------------
  # Job 5: Apply
  #----------------------------------------------------------------------------
  apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    needs: plan
    
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')

    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-terraform

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ env.TF_ENVIRONMENT }}

      - name: Terraform Init
        run: terraform init

      - name: Select Workspace
        run: terraform workspace select ${{ env.TF_ENVIRONMENT }}

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Post Apply Summary
        if: always()
        run: |
          echo "## Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.TF_ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY